<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Каузометрия</title>
<script src="https://cdn.jsdelivr.net/npm/svg2pdf-cli@1.1.10/bin/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{ font-family: Arial, sans-serif; margin:10px; }
#topbar{
  display:flex; flex-wrap:wrap; gap:6px; align-items:center; margin-bottom:8px;
}
#topbar input,#topbar button{ padding:5px 8px; font-size:13px; }
svg{ width:100%; height:520px; border:1px solid #ddd; background:#fafafa; }

/* модалки */
.modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); justify-content:center; align-items:center; z-index:10; }
.modal-content{ background:#fff; padding:14px; border-radius:6px; width:320px; }
.modal-content input, .modal-content select, .modal-content button{ width:100%; margin-bottom:6px; padding:6px; font-size:13px; }

@media print{
  body *{ visibility:hidden; }
  svg{ visibility:visible; position:absolute; left:0; top:0; width:100%; }
  #topbar{ display:none; }
}
</style>
</head>
<body>

<div id="topbar">
  <input id="respName" placeholder="Имя респондента">
  <input id="respDate" placeholder="Дата">
  <button onclick="showEventModal()">+ Событие</button>
  <button onclick="showDeleteEventModal()">− Событие</button>
  <button onclick="showLinkModal()">+ Связь</button>
  <button onclick="showDeleteLinkModal()">− Связь</button>
  <button onclick="saveJSON()">JSON</button>
  <input type="file" accept="application/json" onchange="loadJSON(event)">
  <button onclick="exportPNG()">PNG</button>
  <button onclick="exportPDF()">PDF</button>
  <button onclick="printCausogram()">Печать</button>
</div>

<svg id="viz"></svg>

<!-- ===== модалки ===== -->
<div id="eventModal" class="modal">
<div class="modal-content">
  <input id="mDesc" placeholder="Описание события">
  <input id="mDate" placeholder="дд.мм.гггг / мм.гггг / гггг">
  <select id="mValence">
    <option value="-2">-2</option><option value="-1">-1</option>
    <option value="0">0</option>
    <option value="1">+1</option><option value="2">+2</option>
  </select>
  <select id="mStage">
    <option value="before">До терапии</option>
    <option value="after">После терапии</option>
  </select>
  <select id="mTimeCat">
    <option value="past">Прошлое</option>
    <option value="present">Настоящее</option>
    <option value="future">Будущее</option>
  </select>
  <button onclick="addEvent()">Добавить</button>
  <button onclick="closeModal('eventModal')">Отмена</button>
</div>
</div>

<div id="delEventModal" class="modal">
<div class="modal-content">
  <select id="delEventSel"></select>
  <button onclick="deleteEvent()">Удалить</button>
  <button onclick="closeModal('delEventModal')">Отмена</button>
</div>
</div>

<div id="linkModal" class="modal">
<div class="modal-content">
  <select id="linkA"></select>
  <select id="linkB"></select>
  <select id="linkStage">
    <option value="before">До терапии</option>
    <option value="after">После терапии</option>
  </select>
  <button onclick="addLink()">Создать связь</button>
  <button onclick="closeModal('linkModal')">Отмена</button>
</div>
</div>

<div id="delLinkModal" class="modal">
<div class="modal-content">
  <select id="delLink"></select>
  <button onclick="deleteLink()">Удалить</button>
  <button onclick="closeModal('delLinkModal')">Отмена</button>
</div>
</div>

<script>
let respondent={name:"",date:"",events:[],links:[]};

function parseDateWeight(str){
  if(!str) return 0;
  const p=str.split('.');
  let d=0,m=0,y=0;
  if(p.length===3){d=p[0]-1;m=p[1]-1;y=p[2];}
  else if(p.length===2){m=p[0]-1;y=p[1];}
  else y=p[0];
  return +y + m/12 + d/365;
}
function genId(){
  let max=0;
  respondent.events.forEach(e=>{
    const n=parseInt(e.id.slice(1));
    if(n>max) max=n;
  });
  return "E"+(max+1);
}

/* ---------- modals ---------- */
function showEventModal(){openModal('eventModal')}
function showDeleteEventModal(){
  fillSelect('delEventSel', respondent.events.map(e=>[e.id, e.id+": "+e.description]));
  openModal('delEventModal');
}
function showLinkModal(){
  if(respondent.events.length<2) return alert("Нужно минимум 2 события");
  fillSelect('linkA', respondent.events.map(e=>[e.id, e.description]));
  fillSelect('linkB', respondent.events.map(e=>[e.id, e.description]));
  openModal('linkModal');
}
function showDeleteLinkModal(){
  fillSelect('delLink', respondent.links.map((l,i)=>[i, l.from+" → "+l.to]));
  openModal('delLinkModal');
}
function openModal(id){document.getElementById(id).style.display='flex'}
function closeModal(id){document.getElementById(id).style.display='none'}
function fillSelect(id,arr){
  const s=document.getElementById(id); s.innerHTML='';
  arr.forEach(([v,t])=>{
    const o=document.createElement('option'); o.value=v; o.text=t; s.add(o);
  });
}

/* ---------- events ---------- */
function addEvent(){
  const e={
    id:genId(),
    description:mDesc.value,
    date:mDate.value,
    sortKey:parseDateWeight(mDate.value),
    valence:+mValence.value,
    stage:mStage.value,
    timeCategory:mTimeCat.value
  };
  if(!e.description||!e.date) return alert("Заполните поля");
  respondent.events.push(e);
  closeModal('eventModal');
  render();
}
function deleteEvent(){
  const id=delEventSel.value;
  respondent.events=respondent.events.filter(e=>e.id!==id);
  respondent.links=respondent.links.filter(l=>l.from!==id && l.to!==id);
  closeModal('delEventModal');
  render();
}

/* ---------- links ---------- */
function addLink(){
  const a=linkA.value, b=linkB.value;
  if(a===b) return alert("Выберите разные события");
  respondent.links.push({from:a,to:b,stage:linkStage.value});
  closeModal('linkModal');
  render();
}
function deleteLink(){
  respondent.links.splice(delLink.value,1);
  closeModal('delLinkModal');
  render();
}

/* ---------- render ---------- */
function render(){
  const svg=document.getElementById('viz');
  svg.innerHTML='';
  if(!respondent.events.length) return;

  const pad=80, w=svg.clientWidth-pad*2, h=svg.clientHeight-pad*2;
  const ev=[...respondent.events].sort((a,b)=>a.sortKey-b.sortKey);
  ev.forEach((e,i)=>e.x=pad+i/(ev.length-1||1)*w);
  const y=v=>pad+(2-v)/4*h;

  // Y axis
  [-2,-1,0,1,2].forEach(v=>{ text(30,y(v)+4,v); });

  // links
  respondent.links.forEach(l=>{
    const a=ev.find(e=>e.id===l.from);
    const b=ev.find(e=>e.id===l.to);
    if(!a||!b) return;
    const mid=(a.x+b.x)/2;
    const curve=Math.min(50,Math.abs(a.x-b.x)/2);
    const dir=(Math.random()<0.5?-1:1);
    path(`M${a.x},${y(a.valence)} Q${mid},${(y(a.valence)+y(b.valence))/2-dir*curve} ${b.x},${y(b.valence)}`,
      l.stage==='before'?'#2563eb':'#ea580c');
  });

  // labels collision control
  const used=[];
  
  const maxX = svg.clientWidth - 10; // правая граница SVG
ev.forEach(e=>{
  circle(e.x,y(e.valence), e.stage==='before'?'#3b82f6':'#f97316');

  let dy= -14;
  let dx = 8;
  let box;
  do{
    box={x:e.x+dx,y:y(e.valence)+dy-10,w:160,h:28};
    dy+=16;
  }while(used.some(b=>overlap(b,box)));

  // проверка выхода за правую границу
  if(box.x + box.w > maxX){
    dx -= (box.x + box.w - maxX);
    box.x = e.x + dx;
  }

  used.push(box);
  multilineText(e.x + dx, y(e.valence)+dy-16, `${e.id}: ${e.description}`);
});


  // years
  [...new Set(ev.map(e=>Math.floor(e.sortKey)))].forEach(yv=>{
    const e=ev.find(e=>Math.floor(e.sortKey)===yv);
    text(e.x, h+pad+100, yv,'middle');
  });

  function text(x,y,t,anchor){
    const el=document.createElementNS('http://www.w3.org/2000/svg','text');
    el.setAttribute('x',x); el.setAttribute('y',y);
    if(anchor) el.setAttribute('text-anchor',anchor);
    el.setAttribute('font-size','20');
    el.textContent=t; svg.appendChild(el);
  }
  function circle(x,y,c){
    const el=document.createElementNS('http://www.w3.org/2000/svg','circle');
    el.setAttribute('cx',x); el.setAttribute('cy',y);
    el.setAttribute('r',6); el.setAttribute('fill',c);
    svg.appendChild(el);
  }
  function path(d,c){
    const el=document.createElementNS('http://www.w3.org/2000/svg','path');
    el.setAttribute('d',d); el.setAttribute('fill','none');
    el.setAttribute('stroke',c); el.setAttribute('stroke-width',2);
    svg.appendChild(el);
  }
  function multilineText(x,y,textStr){
    const words=textStr.split(' ');
    const lines=[];
    while(words.length) lines.push(words.splice(0,3).join(' '));
    lines.forEach((l,i)=>{ text(x,y+i*12,l); });
  }
  function overlap(a,b){
    return !(a.x+a.w<b.x || b.x+b.w<a.x || a.y+a.h<b.y || b.y+b.h<a.y);
  }
}

/* ---------- export ---------- */
function prepareSVGForExport(svg) {
  const bbox = svg.getBBox();
  const width = Math.ceil(bbox.x + bbox.width);
  const height = Math.ceil(bbox.y + bbox.height);
  const old = { width: svg.getAttribute('width'), height: svg.getAttribute('height'), viewBox: svg.getAttribute('viewBox') };
  svg.setAttribute('width', width);
  svg.setAttribute('height', height);
  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
  return () => {
    if (old.width === null) svg.removeAttribute('width'); else svg.setAttribute('width', old.width);
    if (old.height === null) svg.removeAttribute('height'); else svg.setAttribute('height', old.height);
    if (old.viewBox === null) svg.removeAttribute('viewBox'); else svg.setAttribute('viewBox', old.viewBox);
  };
}

function saveJSON(){
  respondent.name=respName.value||"respondent";
  respondent.date=respDate.value;
  const blob=new Blob([JSON.stringify(respondent,null,2)],{type:'application/json'});
  download(blob, respondent.name+"_causogram.json");
}
function loadJSON(e){
  const r=new FileReader();
  r.onload=()=>{respondent=JSON.parse(r.result); render();}
  r.readAsText(e.target.files[0]);
}

function exportPNG() {
  const svg = document.getElementById('viz');
  const restore = prepareSVGForExport(svg);

  const serializer = new XMLSerializer();
  let svgStr = serializer.serializeToString(svg);

  // Добавляем белый фон
  svgStr = svgStr.replace('<svg', '<svg style="background:white"');

  const canvas = document.createElement('canvas');
  canvas.width = svg.width.baseVal.value;
  canvas.height = svg.height.baseVal.value;

  const ctx = canvas.getContext('2d');
  const img = new Image();

  const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(blob);

  img.onload = () => {
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    URL.revokeObjectURL(url);
    restore();

    const link = document.createElement('a');
    link.download='kausometry.png';
    link.href=canvas.toDataURL('image/png');
    link.click();
  };
  img.src = url;
}

async function exportPDF() {
  const svg = document.getElementById('viz');
  const restore = prepareSVGForExport(svg);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: svg.width.baseVal.value > svg.height.baseVal.value ? 'landscape' : 'portrait',
    unit: 'px',
    format: [svg.width.baseVal.value, svg.height.baseVal.value]
  });

  await pdf.svg(svg, { x:0, y:0, width: svg.width.baseVal.value, height: svg.height.baseVal.value });
  restore();
  pdf.save('kausometry.pdf');
}

function printCausogram() {
  const svg = document.getElementById('viz');
  const restore = prepareSVGForExport(svg);

  const serializer = new XMLSerializer();
  let svgStr = serializer.serializeToString(svg);
  // добавляем белый фон к SVG
  svgStr = svgStr.replace('<svg', '<svg style="background:white"');

  // открываем новое окно для печати
  const w = window.open('', '_blank');
  w.document.write('<html><head><title>Печать</title></head><body style="margin:20px; font-family:Arial;">');

  // добавляем имя респондента сверху
  w.document.write(`<div style="font-size:18px; font-weight:bold; margin-bottom:10px;">${respName.value || 'Respondent'}</div>`);

  // вставляем SVG
  w.document.write(svgStr);

  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  w.print();
  w.close();

  restore();
}


function download(blob,name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }
function downloadURL(url,name){ const a=document.createElement('a'); a.href=url; a.download=name; a.click(); }

</script>
</body>
</html>
